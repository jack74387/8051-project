#include <8051.h> 

void main(void)
{
    // 7 段顯示器對應 0~9 的編碼
    static const unsigned char seg[10] = {
        0x3f, 0x06, 0x5b, 0x4f, 0x66, 0x6d, 0x7d, 0x27, 0x7f, 0x6f
    };

    // n[0]~n[3] 分別為千、百、十、個位數
    unsigned char n[4] = { 0, 0, 0, 0 };

    // 8051 的 int 一般是 16 bit，可用來計數到 500 以上
    unsigned int i = 0;

    // 用  unsigned char 來儲存這種布林旗標
    unsigned char reset_flag = 0;

    while (1)
    {
        // -----------------------------
        // 1. 顯示數字到 7 段顯示器 (動態掃描)
        // -----------------------------
        // 依序掃描 4 個位數 (千、百、十、個)
        // P1 = 4 + d 表示選擇對應數碼管的 pin 訊號
        for (char d = 0; d < 4; d++)
        {
            P1 = 4 + d;

            // 顯示條件：
            //   - 若不是最左邊 (千位) 時，不顯示 0
            //     除非它的左邊那一位已經不是 0
            //   - 個位 d=3 一律顯示
            if (d == 3 || n[d] != 0 || (d > 0 && n[d - 1] != 0))
            {
                P2 = seg[n[d]];
            }
            else
            {
                P2 = 0x00;
            }

            // 簡單延遲，讓該位段顯示保持一段時間
            for (char j = 0; j < 100; j++)
            {
                /* 空迴圈延遲 */
            }

            // 清除顯示，準備掃描下一位
            P2 = 0x00;
        }

        // -----------------------------
        // 2. 按鍵控制
        // -----------------------------
        // P3_2 = 0 => 按鍵被按住
        if (P3_2 == 0)
        {
            // 記數累加，用來判斷長按時間
            i++;

            // 按住超過 500 => 重置所有位數
            if (i > 500)
            {
                n[0] = n[1] = n[2] = n[3] = 0;
                i = 0;
                reset_flag = 1;  // 做了重置，放開後不再加 1
            }
        }
        else
        {
            // P3_2 == 1 => 按鍵放開
            // 若沒有剛重置過，而且累計按鍵時間超過 10 => 數字 +1
            if (!reset_flag && i > 10)
            {
                n[3]++;
                // 進位處理
                for (char x = 3; x > 0; x--)
                {
                    if (n[x] >= 10)
                    {
                        n[x] = 0;
                        n[x - 1]++;
                    }
                }
            }
            // 不論是否加 1，都把計數歸零
            i = 0;
            // 重置標記清除，下次按鍵放開時才可再次加 1
            reset_flag = 0;
        }
    }
}
